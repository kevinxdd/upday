DDD领域驱动设计
前言
    
DDD 就成了一种“屠龙术”。杀龙是一项比较困难的技术，但是就算学会了，全世界也找不到几条龙，所以屠龙术就显得没有什么用处。DDD 就面临着这样的尴尬，或者说，从整个业界来看，必要性还不够强。或者来说对整个团队要求很高.
但是很多局部的思想很值得学习，面向对象和设计模式各种原则思想的充分实现.


DDD的What,Why,How
What 
DDD（Domain-driven design）领域驱动设计是一种通过将实现连接到持续进化的模型来满足复杂需求的软件开发方法。领域模型是对业务模型的抽象，DDD是把业务模型翻译成系统架构设计的一种方式。
面向对象的分析、设计、编码三种方法融会贯通，成为一个有机的整体，形成一个面向对象的方法学。
/* 个人见解:梳理业务,构建业务领域模型.产品从领域模型的边界和作用域考虑问题出产品方案,技术通过构建的领域模型设计架构设计,写面向领域模型对象的代码实现. */


Why
更好的理解和解决复杂业务问题：DDD 集中关注业务领域，将业务领域的复杂问题划分为不同的子领域，通过建立通用语言、模型和规则，使团队成员更好地理解业务问题和需求。 //  团队协作的好处

更高效的团队合作：通过共同的语言和领域模型，DDD 可以帮助团队成员更好地协作和沟通，避免了因为团队成员之间语言和理解的差异而带来的沟通障碍。// 沟通上的好处

更好的系统架构和设计：DDD 强调将业务逻辑集中在领域模型中，将技术实现细节与业务逻辑分离，使得系统设计更加清晰、模块化，更易于维护和扩展。//这个是代码上的好处

更高质量的软件产品：DDD 能够帮助开发团队更好地理解业务需求，规范开发流程，提高开发质量，从而提供更好的软件产品。// 团队协作的好处

更快的开发速度：DDD 将业务需求与技术实现分离，允许团队成员专注于自己的领域，使得开发过程更加高效和迅速。//  团队协作的好处

总之，DDD 帮助开发团队更好地理解业务需求，提高开发质量和效率，从而更好地满足客户需求。

// 康威定律:业务领域范围和组织架构是息息相关的

// 统一语言和上下文边界方便开发,产品,运营可以快速准确的沟通,避免产生歧义.对于产品来说可以知道技术的代码实现基本思路.技术也能更好的理解产品的需求.

统一语言: 商品在商品上下文,代表的是一个可编辑,可删除的商品

   商品在订单上下文中,代表的是一个商品的快照信息,一般我们称为订单项
// 代码上可以每个领域开发者只关注领域开发的相关业务代码.构建高内聚,低耦合的代码架构.具体好处下面会具体说.


How


DDD主要分为两个部分，战略设计与战术设计，战略设计围绕微服务拆分,聚合根划分.边界定义，战术设计围绕微服务构建.领域建模

1. 领域专家与研发人员一起（研发人员可能就是领域专家），通过一系列的方式方法（DDD并没有明确说明用什么方法(现在大部分用的是"事件风暴")），划分出业务的边界，这个边界就是限界上下文，微服务可以以限界上下文指定微服务的拆分，但是微服务的拆分并不是说一定以限界上下文为边界，这里面还需要考虑其它因数，比如3个火枪手原则、两个披萨原则以及组织架构对微服务拆分的影响等。
// 总结: 战略设计核心就是领域建模
2. 研发人员通过领域模型，领域模型就是DDD中用于指定微服务实现的模型，保存领域知识，通过这种方式DDD通过领域模型围绕业务进⾏建模，并将模型与代码进⾏映射，业务调整影响代码的同时,代码也能直接的反映业务。
// 总结: 战术设计就是对领域模型进行代码落地


名词
沟通层次的概念
领域
什么是领域:领域指的是软件要解决的那些业务问题，所以也可以叫业务领域.
领域的特征:领域是有边界的
// 举例: 电商整个系统架构里面.核心模块包括 商品,订单,支付,营销,用户等等核心模块
其中商品,订单,支付,营销在大的概念理解成交易业务域 其中商品也可以单独称为商品域.
用户消息可以理解成基础服务域.自己也是一个单独的领域


子域
子域是指领域中的一个更小的、具有一定局部性质的子集。在领域模型设计中，通常会将一个复杂的业务领域划分为多个子域，每个子域都有自己的一些特定领域概念、规则和流程等。子域之间可以有交集，也可以相互独立。子域的划分通常是基于业务的不同部分或职责划分而来，目的是简化领域模型的设计和实现。


限界上下文
当系统比较大，开发人员比较多的时候，我们就要考虑模型的拆分了。限界上下文就是一种通过划分模型边界，分而治之的手段。一个上下文，大体上可以理解为一个子系统

// 这个我理解不够透彻. todo
// 统一语言的的业务边界上下文. 商品上下文: 商品这个领域和库存领域且大部分是由一个团队开发的  


领域专家
这里还要说一下，在领域驱动设计中有一个重要的角色叫做“领域专家”，叫业务专家也可以。领域专家需要对业务有总体性和本质性的把握，同时对业务发展也要有一定前瞻性，也就是说，心里要有一盘棋。所以领域专家往往不是一线业务操作人员，在很多企业中，是那些干了很多年业务，逐渐成长起来的中级管理干部。还有一些企业，由产品经理担任领域专家
// 个人见解:就是公司里面对业务理解最透彻那群人.通常这里指的是运营.试公司情况而定


模型层次(代码层次)的概念
充血模型和贫血模型
充血模型和贫血模型, 其实就是一个相对的概念, 在我们之前的MVC架构设计中, 一般数据放在数据层, 也就是实体中只包含属性, 对应的行为放在服务层, 这种实体不包含任何行为只包含属性的模型称之为贫血模型, 而充血模型就是实体中包含属性与行为。


聚合根
整体和部分: 鸟是一个整体对象. 翅膀就是一个部分对象.鸟爪也是一个部分对象
//业务模型中一个对象.对应代码中的对象
将实体和值对象在一致性边界之内组成聚合,使用聚合划分限界上下文(微服务)内部的边界,聚合根做为一种特殊的实体，用于管理聚合内部的实体与值对象，并将自身暴露给外部进行引用。
// 举例: 订单那个类就是一个聚合根(整体)
        订单用户下单地址: 部分
        订单商品快照信息:部分
        订单项: 订单项Id
        订单营销信息:部分
        ....


实体
//业务模型中一个对象.对应代码中的对象
* 实体的特征
1. 唯一标识，对唯一性事物进行建模
2. 包含了业务的关键行为，可以随着业务持续变化
3. 修改时，因为有唯一标识，所以还是同一个实体


  //  订单项: 订单项(唯一标识:订单项Id)是一个实体,订单项有很多业务功能,业务持续变化
  
   实体是有自己的数据表的.
    修改方式:Id修改


值对象
//业务模型中一个对象.对应代码中的对象
* 值对象的特征
1. 描述事物的某个特征，通常作为实体属性存在
2. 创建后即不可变
3. 修改时，用另一个值对象予以替换

// 值对象: 一些快照信息,商品快照是没有业务流程,只用于展示
   订单地址: 没有业务流程,只用于展示
   基本上值对象是不单独拉出来建表的.
   修改方式:替换
   存取方式: 存JSON 或者平铺

领域事件
领域事件表示领域中所发生的事情，通过领域事件可以实现微服务内的信息同步，同时也可以实现对外部系统的解耦。

如上图所示，聚合变更后创建领域事件，领域事件有两种方式进行发布。

1. 与聚合事务一起进行存储，比如存储进一个本地事件表，在由事件转发器转发到消息队列，这样保证的事件不会丢失。
2. 直接进行转发到消息队列，但是此时因为事件还未入口，因此需要在聚合事务与消息队列发布事件之间做XA的2PC事务提交，因为有2PC存在，通常性能不会太好。

> 除了向外部系统发布事件，限界上下文内部的多个聚合也可以通过一些本地事务发布器来进行事务的发布，比如Spring Event 或 EventBus等

// 个人见解:DDD中比较难处理的地方.思想很好.落地很复杂.如果需要事件溯源那更是复杂

战略设计
事件风暴（会议）

what
事件风暴（Event Storming）是领域驱动设计（DDD）中的一种建模工具，旨在促进团队间的协作、探索领域知识和提供共享语言。通过一个半结构化的工作坊，团队成员可以共同探讨业务领域，并将这些讨论中涉及到的事件进行可视化。
// 个人见解：就是团队头脑风暴，领域专家,产品,运营,技术在一起将一个需求从头到尾分析一遍,。

why
事件风暴可以帮助团队发现潜在的瓶颈和漏洞，以及确定可能需要进行优化的部分。此外，这种建模工具还可以帮助团队理解各个业务领域中的语言和概念，并在设计领域模型时提供更好的参考。
总的来说，事件风暴是DDD中非常有用的工具，它可以帮助团队快速、高效地探索业务领域，并为设计和开发领域模型提供更好的基础。
// 个人见解：见批注
how
找个一个独立的空间，领域专家,产品,运营,技术在一起。将业务中设计到的 
将业务中涉及到的 "角色"（可以是用户，可以是管理员，也可以是系统） "命令"（操作），"领域事件"(导致的结果) 梳理可视化出来，呈现在面板上。



示例

领域建模
what
我们系统中要处理的各种“事物”就是领域对象

领域建模的好处
1.将知识可视化，准确、深刻地反映领域知识，并且在业务和技术人员之间达成一致；2.指导系统的设计和编码，也就是说，领域模型应该能够比较容易地转化成数据库模式和代码实现。



战术设计(代码实现)

核心思
洋葱架构

六边形架构

代码层次


// 分层思想主要采用了DIP(依赖倒转,依赖倒置)原则。代码中不稳定的部分，应该依赖稳定的部分
bidding-start: 启动模块,单纯用来启动和放置配置文件
bidding-infrastructure: 基础设施层,DB操作,RPC操作都在这里(粗劣的可以理解成以前的DAO或者Mapper)
bidding-interfaces: 应用接口层,接口定义(粗劣的可以理解成以前的Controlelr)
bidding-common:通用层,放一些通用的枚举,工具类,常量等(最低层)

bidding-application: 应用层,流程操作层
bidding-domain: 领域层,领域操作,包括聚合根,实体,值对象都在这层



 
代码实现
数据库设计
传统方式：
1.ER图法，先思考设计ER图，然后落地数据库物理结构
2.拍脑袋法，直接在待思考和待分析中建立表结构

DDD的方式
业务即模型，模型即实现，将领域模型落地成数据库表结构即可。
// 传统和业务人员聊数据库结构他们是听不懂的。产品或者业务人员是无法识别到实现的难点的。但是在DDD中领域模型产品和业务人员是懂的。直接和他们沟通模型。


词汇表（统一语言）

what
就是将业务阶段涉及到名次定义出来，大家在开发过程中查找使用相同意义的单词来命名

why
多人协作中。其名的方式和理解各有不同，往往一个相同的东西在系统里面会出现好几种表示方式，不仅在代码上造成歧义。也会增加沟通上的障碍。

how
将事件风暴和领域建模阶段涉及到的名次在一个excel或者一张表上面定义。开发人员在设计字段或者命名的时候就会有方向，先对其词汇表上面的词汇进行命名。

领域事件驱动的实现

领域事件表示领域中所发生的事情，通过领域事件可以实现微服务内的信息同步，同时也可以实现对外部系统的解耦。

如上图所示，聚合变更后创建领域事件，领域事件有两种方式进行发布。

1. 与聚合事务一起进行存储，比如存储进一个本地事件表，在由事件转发器转发到消息队列，这样保证的事件不会丢失。
2. 直接进行转发到消息队列，但是此时因为事件还未入口，因此需要在聚合事务与消息队列发布事件之间做XA的2PC事务提交，因为有2PC存在，通常性能不会太好。

> 除了向外部系统发布事件，限界上下文内部的多个聚合也可以通过一些本地事务发布器来进行事务的发布，比如Spring Event 或 EventBus等

// 个人见解:DDD中比较难处理的地方.思想很好.落地很复杂.如果需要事件溯源那更是复杂 具体实现,代码讲解



参考文献
DDD相关概念:
https://blog.csdn.net/baiye_xing/article/details/124081653
https://zhuanlan.zhihu.com/p/361427612
https://mp.weixin.qq.com/s?__biz=MzAwNTQ4MTQ4NQ==&mid=2453586936&idx=1&sn=1ca568242431c8062e744cdcc1106e1a&chksm=8cd1969abba61f8c0061ade10dff086188fd68badfd646c55470cc91b3bc7f5b726363656bb9&scene=27
DDD核心思想: 殷浩详解DDD系列(好文)
https://developer.aliyun.com/article/713097 https://developer.aliyun.com/article/715802 https://developer.aliyun.com/article/758292 https://mp.weixin.qq.com/s/w1zqhWGuDPsCayiOgfxk6w   https://developer.aliyun.com/article/783664 
事件风暴
https://zhuanlan.zhihu.com/p/399103071
六边形架构
https://zhuanlan.zhihu.com/p/113681224
实体和值对象
https://time.geekbang.org/column/article/152677?screen=full
xdd的示例代码仓库
https://github.com/kevinxdd/upday
DDD实例:
https://time.geekbang.org/column/article/629262

